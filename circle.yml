machine:
  environment:
    IMPORT_PATH: "github.com/docker/notary"
    BASE_DIR: "../../..$HOME/.go_project/src/$IMPORT_PATH"
    GO15VENDOREXPERIMENT: "1"
    GOPATH: "$GOPATH:$HOME/.go_project"

dependencies:
  override:
    - mkdir -p $HOME/.go_project/src/$(dirname $IMPORT_PATH)
    - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $BASE_DIR
    - go get -u github.com/golang/lint/golint
test:
  pre:
    # go fmt
    - test -z "$(gofmt -s -l . | grep -v vendor | grep -v .pb. | tee /dev/stderr)"
    # golint
    - test -z "$(find . -type f -name "*.go" -exec golint {} \; | grep -v vendor | grep -v .pb. | tee /dev/stderr)"
    # go vet
    - test -z "$(go tool vet -printf=false . 2>&1 | grep -v vendor/ | tee /dev/stderr)"

  override:
    # Run tests with coverage
    - go list ./... | grep -v vendor | xargs go test:
        pwd: "$BASE_DIR"
